/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model,
 * with a special exception for a designated admin user. All user data is
 * considered private and can only be accessed by the user who owns it, or
 * by the admin.
 *
 * Data Structure: 
 * - /users/{userId}: All user data is stored in a top-level `users` collection.
 *   Each user has a single document, where the document ID is their unique
 *   Firebase Authentication UID (e.g., /users/abc123xyz456).
 * - /content/{pageId}: Stores dynamic content for the website. This data is
 *   publicly readable but only writable by the admin.
 *
 * Key Security Decisions:
 * - Admin Access: A specific user UID is granted admin privileges, allowing
 *   them to read, update, and delete any user's data, and to list all users.
 *   The admin also has exclusive write access to the /content collection.
 * - Public Read for Content: The /content collection is readable by anyone,
 *   allowing the public-facing website to display dynamic content.
 * - Disallow User Listing (for non-admins): It is not possible for regular
 *   users to query or list all documents in the `/users` collection. This is a
 *   critical privacy feature to prevent enumeration of the user base.
 * - Strict Ownership (for non-admins): A user can only read, create, update,
 *   or delete their own user document. Access to other users' documents is denied.
 * - Self-Creation: A newly signed-in user is explicitly granted permission
 *   to create their own user document, establishing their presence in the
 *   database.
 *
 * Denormalization for Authorization: This model is simple and does not require
 * complex denormalization. The user's UID in the document path (`/users/{userId}`)
 * serves as the primary authorization key, eliminating the need for slow `get()`
 * calls to other documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if a user is authenticated via Firebase Auth.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the request is from the designated admin user.
     */
    function isAdmin() {
      // UID for the admin account
      return isSignedIn() && request.auth.uid == 'y4poDUkAStdmtsyUArHKXziEANn1';
    }

    /**
     * Checks if the authenticated user's UID matches the document's userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Confirms the document being changed already exists and the user is the owner.
     * Crucial for secure update and delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates a user creating their own user document.
     * 1. The user must be the owner of the path.
     * 2. The document's internal 'id' field MUST match the user's UID to
     *    ensure relational integrity is established at creation.
     */
    function isCreatingSelf(userId) {
      return isOwner(userId)
          && request.resource.data.id == userId;
    }

    /**
     * Validates a user updating their own user document.
     * 1. The user must be the owner of the existing document.
     * 2. The document's internal 'id' field MUST be immutable to prevent
     *    the ownership link from being broken.
     */
    function isUpdatingSelf(userId) {
      return isExistingOwner(userId)
          && request.resource.data.id == resource.data.id;
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Manages private user profile documents.
     * @path /users/{userId}
     * @allow (get) A user can read their own profile. An admin can read any profile.
     * @allow (create) A new user can create their own profile document.
     * @allow (list) An admin can list all documents in the 'users' collection.
     * @deny (get) A user cannot read another user's profile unless they are an admin.
     * @principle Restricts access to a user's own data tree, with full access for admins.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isCreatingSelf(userId);
      allow update: if isUpdatingSelf(userId) || isAdmin();
      allow delete: if isExistingOwner(userId) || isAdmin();
    }
    
    /**
     * @description Manages dynamic website content.
     * @path /content/{pageId}
     * @allow (read) Publicly readable by anyone to display on the website.
     * @allow (write) Writable only by the admin user.
     * @principle Separates public content from private user data with distinct access rules.
     */
    match /content/{pageId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }
  }
}
